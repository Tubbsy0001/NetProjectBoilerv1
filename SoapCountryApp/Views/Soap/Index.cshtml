@model SoapCountryApp.Models.SoapWorkbenchViewModel

@{
    ViewData["Title"] = "SOAP WSDL Explorer";
}

<section class="soap-hero mb-4">
    <div class="hero-content">
        <div>
            <p class="hero-eyebrow">Universal SOAP Explorer</p>
            <h1 class="display-6 fw-semibold mb-3">Load any SOAP contract, discover every executable function, and copy valid envelopes instantly.</h1>
            <p class="lead mb-0">Point the tool at your primary WSDL, stack additional descriptor feeds for special endpoints, and keep every configuration as a saved search.</p>
        </div>
        <div class="hero-metrics">
            <div class="metric-block">
                <div class="metric-label">Operations</div>
                <div class="metric-value">@Model.Operations.Count</div>
            </div>
            <div class="metric-block">
                <div class="metric-label">Sources</div>
                <div class="metric-value">@Model.SourceCount</div>
            </div>
            <div class="metric-block">
                <div class="metric-label">Saved Searches</div>
                <div class="metric-value">@Model.SavedSearches.Count</div>
            </div>
        </div>
    </div>
</section>

<section class="soap-workbench">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="panel">
                <h5 class="panel-title mb-3">Discover operations</h5>
                <form asp-action="Describe" method="post" class="wsdl-form">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label asp-for="WsdlUrl" class="form-label"></label>
                        <input asp-for="WsdlUrl" class="form-control" placeholder="https://example.com/service?wsdl" />
                    </div>
                    <div class="mb-3">
                        <label asp-for="AdditionalSources" class="form-label"></label>
                        <textarea asp-for="AdditionalSources" class="form-control" rows="4" placeholder="https://api.example.com/functions.xml&#10;https://example.com/extra.wsdl"></textarea>
                        <small class="text-muted">One URL per line. Supports extra WSDL files or executable-function manifests.</small>
                    </div>
                    <div class="form-check mb-3">
                        <input asp-for="FollowImports" class="form-check-input" />
                        <label asp-for="FollowImports" class="form-check-label"></label>
                    </div>
                    <div class="mb-3">
                        <label asp-for="ExecutionEndpoint" class="form-label"></label>
                        <input asp-for="ExecutionEndpoint" class="form-control" id="execution-endpoint" placeholder="https://api.example.com/service" />
                        <small class="text-muted">Used when invoking payloads from the operations table.</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Load descriptors</button>
                </form>
                @if (!string.IsNullOrWhiteSpace(Model.Error))
                {
                    <div class="alert alert-warning mt-3 mb-0">@Model.Error</div>
                }
                else if (Model.HasOperations)
                {
                    <div class="wsdl-meta mt-3">
                        <div><span class="label">Operations:</span> <strong>@Model.Operations.Count</strong></div>
                        <div><span class="label">Sources:</span> <strong>@Model.SourceCount</strong></div>
                        @if (Model.ParsedAt.HasValue)
                        {
                            <div><span class="label">Last parsed:</span> @Model.ParsedAt.Value.ToLocalTime().ToString("g")</div>
                        }
                        @if (Model.SourceCount > 0)
                        {
                            <details class="small mt-2">
                                <summary class="text-muted">Show loaded sources</summary>
                                <ul class="ps-3 mb-0">
                                    @foreach (var source in Model.LoadedSources)
                                    {
                                        <li class="text-break">@source</li>
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                }
                @if (Model.SavedSearches.Any())
                {
                    <div class="saved-searches mt-4">
                        <div class="saved-title">Saved searches</div>
                        <ul class="list-unstyled mb-0">
                            @foreach (var saved in Model.SavedSearches)
                            {
                                <li class="saved-search-item">
                                    <div>
                                        <div class="fw-semibold text-break">@saved.DisplayName</div>
                                        <div class="text-muted small">@saved.SavedAt.ToLocalTime().ToString("g")</div>
                                    </div>
                                    <a class="btn btn-outline-secondary btn-sm" asp-action="Index" asp-route-id="@saved.Id">Load</a>
                                </li>
                            }
                        </ul>
                        <div class="text-muted extra-note small mt-2">
                            Saved to <code>App_Data\searchHistory.json</code> inside this project.
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-8">
            <div class="panel operations-panel h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="panel-title mb-0">Available operations</h5>
                    @if (Model.HasOperations)
                    {
                        <span class="badge bg-secondary">@Model.Operations.Count</span>
                    }
                </div>

                @if (!Model.HasOperations)
                {
                    <div class="empty-state text-center py-5">
                        <p class="h5 mb-1">No operations yet</p>
                        <p class="text-muted mb-0">Paste one or more URLs above and load them to explore the contract.</p>
                    </div>
                }
                else
                {
                    <div class="operations-list">
                        @foreach (var op in Model.Operations)
                        {
                            <article class="operation-card">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <h6 class="mb-1">@op.Name</h6>
                                        @if (!string.IsNullOrWhiteSpace(op.Documentation))
                                        {
                                            <p class="text-muted small mb-2">@op.Documentation</p>
                                        }
                                        <dl class="operation-meta small">
                                            <div>
                                                <dt>SOAP Action</dt>
                                                <dd>@(string.IsNullOrWhiteSpace(op.SoapAction) ? "N/A" : op.SoapAction)</dd>
                                            </div>
                                            <div>
                                                <dt>Input Message</dt>
                                                <dd>@(string.IsNullOrWhiteSpace(op.InputMessage) ? "N/A" : op.InputMessage)</dd>
                                            </div>
                                            <div>
                                                <dt>Output Message</dt>
                                                <dd>@(string.IsNullOrWhiteSpace(op.OutputMessage) ? "N/A" : op.OutputMessage)</dd>
                                            </div>
                                            <div>
                                                <dt>Parameters</dt>
                                                <dd>@op.Parameters.Count</dd>
                                            </div>
                                            <div>
                                                <dt>Source</dt>
                                                <dd class="text-break">@op.Source</dd>
                                            </div>
                                        </dl>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm copy-button" data-copy="@System.Net.WebUtility.HtmlEncode(op.SampleEnvelope)">Copy envelope</button>
                                </div>

                                @if (op.Parameters.Count > 0)
                                {
                                    <div class="table-responsive mt-3">
                                        <table class="table table-sm table-borderless align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Parameter</th>
                                                    <th scope="col">Type</th>
                                                    <th scope="col">Value expectations</th>
                                                    <th scope="col">Example</th>
                                                    <th scope="col">Structure</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var parameter in op.Parameters)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="fw-semibold">@parameter.Name</div>
                                                        @if (!string.IsNullOrWhiteSpace(parameter.Description))
                                                        {
                                                            <div class="text-muted small">@parameter.Description</div>
                                                        }
                                                        @if (parameter.AllowedValues?.Count > 0)
                                                        {
                                                            <div class="allowed-values text-muted small mt-1">
                                                                <span class="fw-semibold">Allowed:</span>
                                                                @if (parameter.AllowedValues.Count <= 5)
                                                                {
                                                                    @string.Join(", ", parameter.AllowedValues)
                                                                }
                                                                else
                                                                {
                                                                    <details>
                                                                        <summary>show list (@parameter.AllowedValues.Count)</summary>
                                                                        <div>@string.Join(", ", parameter.AllowedValues)</div>
                                                                    </details>
                                                                }
                                                            </div>
                                                        }
                                                    </td>
                                                    <td class="text-muted small">
                                                        @(string.IsNullOrWhiteSpace(parameter.TypeName) ? "—" : parameter.TypeName)
                                                        @if (parameter.IsArray)
                                                        {
                                                            <span class="badge bg-light text-dark ms-2">Repeating</span>
                                                        }
                                                    </td>
                                                    <td class="text-muted small">
                                                        @(string.IsNullOrWhiteSpace(parameter.ValueDescription) ? "—" : parameter.ValueDescription)
                                                    </td>
                                                    <td class="text-muted small">
                                                        @(string.IsNullOrWhiteSpace(parameter.ExampleValue) ? "—" : parameter.ExampleValue)
                                                    </td>
                                                    <td>
                                                        <pre class="sample-snippet mb-0">@parameter.SampleXml</pre>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted small mb-0 mt-3">This operation does not declare input parameters.</p>
                                }

                                @{
                                    var opId = $"op{Guid.NewGuid():N}";
                                    var payloadId = $"payload-{opId}";
                                    var responseId = $"response-{opId}";
                                }
                                <div class="execution-panel mt-4">
                                    <label class="form-label">Try this operation</label>
                                    <textarea class="form-control operation-payload" id="@payloadId" rows="8">@op.SampleEnvelope</textarea>
                                    <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
                                        <button type="button"
                                                class="btn btn-success btn-sm execute-btn"
                                                data-target="@payloadId"
                                                data-response="@responseId"
                                                data-soap-action="@op.SoapAction"
                                                data-operation="@op.Name">
                                            Execute
                                        </button>
                                        <span class="text-muted small" data-status="@responseId"></span>
                                    </div>
                                    <div class="response-pane mt-2" id="@responseId"></div>
                                </div>

                                <details class="mt-3">
                                    <summary class="small text-muted">Full envelope template</summary>
                                    <pre class="sample-snippet mb-0">@op.SampleEnvelope</pre>
                                </details>
                            </article>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        const invokeUrl = '@Url.Action("Invoke", "Soap")';

        document.querySelectorAll('.copy-button').forEach(btn => {
            btn.addEventListener('click', async () => {
                const payload = btn.getAttribute('data-copy');
                if (!payload) return;
                const decoded = payload
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'");
                try {
                    await navigator.clipboard.writeText(decoded);
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy envelope', 2000);
                } catch {
                    btn.textContent = 'Copy failed';
                    setTimeout(() => btn.textContent = 'Copy envelope', 2000);
                }
            });
        });

        document.querySelectorAll('.execute-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const endpointInput = document.getElementById('execution-endpoint');
                const endpoint = endpointInput?.value?.trim() ?? '';
                if (!endpoint) {
                    alert('Enter an execution endpoint URL above before invoking.');
                    endpointInput?.focus();
                    return;
                }

                const payloadElement = document.getElementById(button.dataset.target);
                const payload = payloadElement?.value;
                if (!payload) {
                    alert('Payload is empty.');
                    return;
                }

                const soapAction = button.dataset.soapAction || '';
                const responseId = button.dataset.response;
                const responsePane = document.getElementById(responseId);
                const statusEl = document.querySelector(`[data-status=\"${responseId}\"]`);
                if (statusEl) {
                    statusEl.textContent = 'Executing...';
                }
                if (responsePane) {
                    responsePane.innerHTML = '';
                }

                try {
                    const result = await fetch(invokeUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            endpointUrl: endpoint,
                            soapAction: soapAction,
                            payload: payload
                        })
                    });
                    const body = await result.json();
                    if (statusEl) {
                        statusEl.textContent = body?.error
                            ? `Error: ${body.error}`
                            : `Status: ${body.statusCode}`;
                    }
                    if (responsePane) {
                        if (body?.responseBody) {
                            const escaped = body.responseBody
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;');
                            responsePane.innerHTML = `<pre class="sample-snippet mb-0">${escaped}</pre>`;
                        } else {
                            responsePane.innerHTML = '<div class="text-muted small">No response body.</div>';
                        }
                    }
                } catch (err) {
                    if (statusEl) {
                        statusEl.textContent = `Error: ${err}`;
                    }
                }
            });
        });
    </script>
}
